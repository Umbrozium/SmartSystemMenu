name: Build SmartSystemMenu

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build-x64:
    name: Build SmartSystemMenu64 (x64)
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install .NET Framework 4.0 Targeting Pack
        shell: pwsh
        run: |
          $vsInstaller = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vs_installer.exe"
          & $vsInstaller modify `
          --installPath "C:\Program Files\Microsoft Visual Studio\2022\Enterprise" `
          --add Microsoft.Net.Component.4.0.TargetingPack `
          --quiet --norestart --wait

      - name: Verify .NET 4.0 reference assemblies
        shell: pwsh
        run: |
          Test-Path "C:\Program Files (x86)\Reference Assemblies\Microsoft\Framework\.NETFramework\v4.0"

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Restore NuGet packages
        run: nuget restore SmartSystemMenu.sln

      - name: Build SmartSystemMenu64
        run: |
          msbuild SmartSystemMenu.sln ^
          /t:SmartSystemMenu64 ^
          /p:Configuration=Release ^
          /p:Platform=x64 ^
          /m

      - name: Upload SmartSystemMenu64.exe artifact
        uses: actions/upload-artifact@v4
        with:
          name: SmartSystemMenu64
          path: |
            **/bin/x64/Release/SmartSystemMenu64.exe

  build-launcher:
    name: Build Launcher and Hooks
    runs-on: windows-latest
    needs: build-x64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Restore NuGet packages
        run: nuget restore SmartSystemMenu.sln

      - name: Download SmartSystemMenu64
        uses: actions/download-artifact@v4
        with:
          name: SmartSystemMenu64
          path: SmartSystemMenu/SmartSystemMenu

      - name: Copy embedded executable to expected location
        run: |
          copy artifacts\SmartSystemMenu64\SmartSystemMenu64.exe `
               SmartSystemMenu\bin\x64\Release\SmartSystemMenu64.exe

      - name: Build launcher and hooks
        run: |
          msbuild SmartSystemMenu.sln ^
          /p:Configuration=Release ^
          /p:Platform=AnyCPU ^
          /m

      - name: Upload final release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: SmartSystemMenu-Release
          path: |
            **/bin/**/Release/SmartSystemMenu.exe
            **/bin/**/Release/SmartSystemMenuHook.dll
            **/bin/**/Release/SmartSystemMenuHook64.dll
